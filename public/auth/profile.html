<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto px-4 py-8">
    <header class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold">My App</h1>
      <nav>
        <a href="/dashboard" class="text-blue-500 hover:underline mr-4">Dashboard</a>
        <a href="/logout" class="text-blue-500 hover:underline">Logout</a>
      </nav>
    </header>

    <main class="bg-white p-8 rounded-lg shadow-md">
      <h2 class="text-2xl font-bold mb-4">Profile</h2>

      <!-- Success message container -->
      <div id="successMessage" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
        <span id="successMessageText" class="block sm:inline"></span>
        <span class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="document.getElementById('successMessage').classList.add('hidden')">
          <svg class="fill-current h-6 w-6 text-green-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
        </span>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="bg-gray-50 p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-2">Your Information</h3>
          <div class="space-y-4">
            <div>
              <p class="text-sm text-gray-500">Username</p>
              <p id="username" class="font-medium"></p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Email</p>
              <p id="email" class="font-medium"></p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Bio</p>
              <p id="bio" class="font-medium"></p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Location</p>
              <p id="location" class="font-medium"></p>
            </div>
            <button id="editProfileBtn" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
              Edit Profile
            </button>
          </div>
        </div>

        <div class="md:col-span-2">
          <h3 class="text-lg font-semibold mb-4">Profile Details</h3>
          <div id="profileContent" class="bg-gray-50 p-6 rounded-lg">
            <!-- Profile content will be loaded here -->
            <div id="loadingProfile" class="text-center py-8">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
              <p class="mt-2">Loading profile...</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Edit Profile Modal -->
  <div id="editProfileModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3 text-center">
        <h3 class="text-lg leading-6 font-medium text-gray-900">Edit Profile</h3>
        <form id="editProfileForm" action="/update-profile" method="POST" class="mt-2 px-7 py-3 space-y-4">
          <div>
            <label for="editUsername" class="block text-sm font-medium text-gray-700">Username</label>
            <input type="text" id="editUsername" name="username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <p id="usernameError" class="mt-1 text-sm text-red-600 hidden">Username is required</p>
          </div>
          <div>
            <label for="editEmail" class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="editEmail" name="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <p id="emailError" class="mt-1 text-sm text-red-600 hidden">Valid email is required</p>
          </div>
          <div>
            <label for="editBio" class="block text-sm font-medium text-gray-700">Bio</label>
            <textarea id="editBio" name="bio" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>
          <div>
            <label for="editLocation" class="block text-sm font-medium text-gray-700">Location</label>
            <input type="text" id="editLocation" name="location" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div class="flex justify-end space-x-4">
            <button type="button" id="cancelEditBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
              Cancel
            </button>
            <button type="submit" id="saveProfileBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-500 border border-transparent rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
              Save
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Loading state for profile
    const loadingProfile = document.getElementById('loadingProfile');
    const successMessage = document.getElementById('successMessage');
    const successMessageText = document.getElementById('successMessageText');

    // Function to show success message
    function showSuccessMessage(message) {
      successMessageText.textContent = message;
      successMessage.classList.remove('hidden');
      // Hide message after 5 seconds
      setTimeout(() => {
        successMessage.classList.add('hidden');
      }, 5000);
    }

    // Function to display "Not provided" for null values
    function displayValue(value) {
      return value || 'Not provided';
    }

    // Fetch user details from the server
    function fetchUserDetails() {
      fetch('/user-details')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch user details');
          }
          return response.json();
        })
        .then(data => {
          document.getElementById('username').textContent = data.username;
          document.getElementById('email').textContent = data.email;
          document.getElementById('bio').textContent = displayValue(data.bio);
          document.getElementById('location').textContent = displayValue(data.location);

          // Display profile content
          displayProfile(data);

          // Hide loading state
          loadingProfile.classList.add('hidden');

          // Check for success message in URL
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.has('success') && urlParams.get('success') === 'profile_updated') {
            showSuccessMessage('Profile updated successfully!');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          loadingProfile.innerHTML = `
            <p class="text-red-500">Failed to load profile. Please try again later.</p>
            <button onclick="fetchUserDetails()" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
              Retry
            </button>
          `;
        });
    }

    // Display profile content
    function displayProfile(user) {
      const profileContent = document.getElementById('profileContent');
      profileContent.innerHTML = `
        <div class="bg-gray-50 p-6 rounded-lg">
          <h4 class="text-xl font-semibold mb-4">${user.username}'s Profile</h4>
          <div class="space-y-4">
            <div>
              <p class="text-sm text-gray-500">Bio</p>
              <p class="font-medium">${displayValue(user.bio)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Location</p>
              <p class="font-medium">${displayValue(user.location)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Member since</p>
              <p class="font-medium">${new Date(user.created_at).toLocaleDateString()}</p>
            </div>
          </div>
        </div>
      `;
    }

    // Initial fetch of user details
    fetchUserDetails();

    // Edit profile functionality
    const editProfileBtn = document.getElementById('editProfileBtn');
    const editProfileModal = document.getElementById('editProfileModal');
    const cancelEditBtn = document.getElementById('cancelEditBtn');

    editProfileBtn.addEventListener('click', () => {
      // Fetch current user details to populate the form
      fetch('/user-details')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch user details');
          }
          return response.json();
        })
        .then(data => {
          document.getElementById('editUsername').value = data.username;
          document.getElementById('editEmail').value = data.email;
          document.getElementById('editBio').value = data.bio || '';
          document.getElementById('editLocation').value = data.location || '';
          editProfileModal.classList.remove('hidden');
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to load profile data. Please try again.');
        });
    });

    cancelEditBtn.addEventListener('click', () => {
      editProfileModal.classList.add('hidden');
      // Reset form validation messages
      document.getElementById('usernameError').classList.add('hidden');
      document.getElementById('emailError').classList.add('hidden');
    });
  </script>
</body>
</html>